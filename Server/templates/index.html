<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Leak Analysis Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      padding: 20px;
      background-color: #eef1f5;
      color: #1c1c1c;
    }

    h1 {
      font-weight: 700;
      color: #0d47a1;
    }

    .table {
      background: #ffffff;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 3px 10px rgba(0,0,0,0.15);
    }

    .table th {
      background: #0d47a1;
      color: #ffffff;
      font-weight: 600;
    }

    .table td, .table th {
      vertical-align: middle;
    }

    .btn {
      font-weight: 500;
      border-radius: 6px;
      transition: 0.3s;
    }

    .btn-info { background-color: #1565c0; border: none; }
    .btn-info:hover { background-color: #0d47a1; }

    .btn-primary { background-color: #1e88e5; border: none; }
    .btn-primary:hover { background-color: #1565c0; }

    .btn-success { background-color: #2e7d32; border: none; }
    .btn-success:hover { background-color: #1b5e20; }

    .btn-warning { background-color: #f9a825; border: none; color: #fff; }
    .btn-warning:hover { background-color: #f57f17; }

    .toggle-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      border-radius: 6px;
    }

    .badge {
      margin-right: 4px;
      font-size: 0.85em;
      padding: 4px 6px;
      background-color: #e3f2fd;
      color: #0d47a1;
      border: 1px solid #bbdefb;
    }

    .chart-container {
      margin-top: 25px;
      background: #ffffff;
      padding: 15px;
      border-radius: 10px;
      height: 250px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }

    .chart-container canvas { height: 100% !important; }

    .dark-mode {
      background-color: #121212 !important;
      color: #f0f0f0 !important;
    }

    .dark-mode table { background-color: #1e1e1e; color: #ffffff; }
    .dark-mode th { background-color: #2c3e50 !important; color: #fff; }
    .dark-mode .badge { background-color: #34495e; color: #fff; border: none; }
    .dark-mode .chart-container { background-color: #1e1e1e; box-shadow: 0 2px 6px rgba(255,255,255,0.1); }
  </style>
</head>
<body class="bg-light" id="mainBody">

  <button class="btn btn-sm btn-dark toggle-btn" onclick="toggleDarkMode()">üåì Dark Mode</button>

  <div class="container mt-4" id="dashboardContainer">
    <h1 class="mb-4"> Leak Watcher </h1>

    <form action="/manifest" method="get" class="mb-3">
      <button type="submit" class="btn btn-info mb-3">üîç Analyze APK Manifest</button>
    </form>

    <button class="btn btn-info download-btn" onclick="downloadPDF()">üìÑ Download PDF</button>
   <div style="margin-top:20px; display:inline-block;">
      <form action="{{ url_for('obfuscation_redirect') }}" method="get" style="display:inline;">
        <button type="submit" class="btn btn-primary">Obfuscation Analysis</button>
      </form>
    </div>



    <div class="row mb-4">
      <div class="col-md-3">
        <div class="card text-bg-primary mb-3">
          <div class="card-body">
            <h5 class="card-title">Total Requests</h5>
            <p class="card-text">{{ total_requests }}</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-bg-success mb-3">
          <div class="card-body">
            <h5 class="card-title">Unique Domains</h5>
            <p class="card-text">{{ unique_sdks }}</p>
          </div>
        </div>
      </div>
    </div>

    <form method="get" class="row g-2 align-items-center mb-3" id="filterForm">
      <div class="col-md-auto">
        <input type="text" name="search" class="form-control" id="searchInput" placeholder="üîç Search..." value="{{ request.args.get('search', '') }}">
      </div>
      <div class="col-md-auto">
        <select name="sdk" class="form-select" id="sdkSelect">
          <option value="All">Domain</option>
          {% for sdk in sdk_list %}
            <option value="{{ sdk }}" {% if sdk == request.args.get('sdk') %}selected{% endif %}>{{ sdk }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-auto">
        <button type="submit" class="btn btn-primary">Apply</button>
        <a href="/download" class="btn btn-success">üì• JSON</a>
        <a href="/export" class="btn btn-warning">üì§ CSV</a>
          <a href="/risk" class="btn btn-danger">‚ö†Ô∏è Risk Analysis</a>

      </div>
    </form>

    <div class="table-responsive mb-4">
      <table class="table table-bordered table-hover" id="logTable">
        <thead>
          <tr>
            <th>üì± App Domain</th>
            <th>üì§ Data Sent</th>
            <th>‚è∞ Timestamp</th>
          </tr>
        </thead>
        <tbody id="logTableBody">
          {% for log in logs %}
            <tr>
              <td>{{ log['App Domain'] }}</td>
              <td>
                {% if log['Data Sent'] is mapping %}
                  {% for key, value in log['Data Sent'].items() %}
                    <span class="badge">{{ key }}</span>: {{ value }}<br>
                  {% endfor %}
                {% else %}
                  {{ log['Data Sent'] }}
                {% endif %}
              </td>
              <td>{{ log['Timestamp'] }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="row">
      <div class="col-md-12 chart-container">
        <h5>Top Domain Requests</h5>
        <canvas id="topSDKsChart"></canvas>
      </div>
    </div>
  </div>

<script>
  function toggleDarkMode() {
    const body = document.getElementById("mainBody");
    const enabled = body.classList.toggle("dark-mode");
    localStorage.setItem("darkMode", enabled);
  }
  window.addEventListener('load', () => {
    if (localStorage.getItem("darkMode") === "true")
      document.getElementById("mainBody").classList.add("dark-mode");
  });

  let topSDKsChart;
  function updateChart(data) {
    const counter = {};
    data.forEach(log => {
      counter[log['App Domain']] = (counter[log['App Domain']] || 0) + 1;
    });
    const labels = Object.keys(counter);
    const counts = Object.values(counter);

    const ctx = document.getElementById('topSDKsChart').getContext('2d');
    if (topSDKsChart) topSDKsChart.destroy();
    topSDKsChart = new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets: [{ label: 'Requests', data: counts, backgroundColor: '#1565c0' }] },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
    });
  }

  setInterval(() => {
    const search = document.getElementById("searchInput").value.toLowerCase();
    const sdk = document.getElementById("sdkSelect").value;
    fetch('/api/logs').then(res => res.json()).then(data => {
      let filtered = data;
      if (search.trim()) {
        filtered = filtered.filter(d =>
          d['App Domain'].toLowerCase().includes(search) ||
          (typeof d['Data Sent'] === 'object' && Object.keys(d['Data Sent']).some(key => key.toLowerCase().includes(search))) ||
          (typeof d['Data Sent'] === 'string' && d['Data Sent'].toLowerCase().includes(search))
        );
      }
      if (sdk !== 'All') filtered = filtered.filter(d => d['App Domain'] === sdk);

      const tbody = document.getElementById("logTableBody");
      tbody.innerHTML = "";
      filtered.forEach(log => {
        let dataSentHtml = "";
        if (typeof log["Data Sent"] === 'object' && log["Data Sent"] !== null) {
          for (const [key, value] of Object.entries(log["Data Sent"])) {
            dataSentHtml += `<span class="badge">${key}</span>: ${value}<br>`;
          }
        } else { dataSentHtml = log["Data Sent"]; }
        tbody.innerHTML += `<tr>
          <td>${log["App Domain"]}</td>
          <td>${dataSentHtml}</td>
          <td>${log["Timestamp"]}</td>
        </tr>`;
      });

      updateChart(filtered);
    });
  }, 5000);

  updateChart({{ logs | tojson }});

  function downloadPDF() {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p','mm','a4');
    const headers = [["App Domain","Data Sent","Timestamp"]];
    const data = [];
    document.querySelectorAll("#logTable tbody tr").forEach(tr => {
      const row = [];
      tr.querySelectorAll("td").forEach(td => {
        row.push(td.innerText.trim());
      });
      data.push(row);
    });
    pdf.autoTable({ head: headers, body: data, startY: 10, theme: 'grid', headStyles: { fillColor: [13,71,161] } });

    const chart = document.getElementById("topSDKsChart");
    html2canvas(chart, { scale: 2 }).then(canvas => {
      const imgData = canvas.toDataURL("image/png");
      pdf.addPage();
      const pageWidth = pdf.internal.pageSize.getWidth();
      const imgHeight = (canvas.height * pageWidth) / canvas.width;
      pdf.addImage(imgData, 'PNG', 0, 10, pageWidth, imgHeight);
      pdf.save("SDK_Leak_Report.pdf");
    });
  }
</script>
<footer class="text-center mt-4" style="padding: 15px; background: #0d47a1; color: white; border-radius: 8px;">
  <p style="margin: 0;">
    Leak Analysis Dashboard ¬© 2025 | Designed & Developed by <b>Shubhangi Yadav</b> üíª
  </p>

</footer>

</body>
</html>
